#!/bin/sh

make_hash() {
    echo -n "$@" | md5sum | head -c 8
}

path_to_stream() {
    local root=$1
    echo /tmp/flv2rtspd/$root
}

path_to_pid() {
    local root=$1 leaf=$2
    echo $(path_to_stream $root)/$leaf.pid
}

path_to_log() {
    local root=$1 leaf=$2
    echo $(path_to_stream $root)/$leaf.log
}

daemon_start() {
    local root=$1 leaf=$2
    shift 2
    mkdir -p $(path_to_stream $root)
    echo "starting..."
    start-stop-daemon -S -m -p $(path_to_pid $root $leaf) -b -a /bin/sh -- -c "exec setsid $* 1>$(path_to_log $root $leaf) 2>&1"
    echo "started"
}

daemon_stop() {
    local root=$1 leaf=$2
    echo "stopping..."
    start-stop-daemon -K -o -p $(path_to_pid $root $leaf)
    echo "stopped"
}

status() {
    local root=$1 leaf=$2
    kill -0 $(cat $(path_to_pid $root $leaf)) &>/dev/null
    if [ $? -eq 0 ]; then
        echo "running"
    else
        echo "stopped"
    fi
}
